#include <iostream>
#include <cstring>
#include <unistd.h>
#include <map>
#include <vector>
#include <cstdio>
using namespace std;

#define THRESHOLD 50

long long get_usage(int pid){
	char stat_file[100];
    snprintf(stat_file,sizeof(stat_file), "/proc/%d/stat", pid);
    FILE *fp = fopen(stat_file, "r");
    if (!fp){
        perror("fopen");
        exit(1);
    }

    char buf[1000];
    fgets(buf, sizeof(buf), fp);
    char *p = strtok(buf, " ");
    int i = 0;
    long long utime, stime, starttime;
    while(p){
	    if(i == 13) utime = strtol(p, NULL, 10);
        if(i == 14) stime = strtol(p, NULL, 10);
        p = strtok(NULL, " ");
        i++;
    }
	fclose(fp);
	return (utime + stime);
}

long long get_total_usage(){
	FILE *fp = fopen("/proc/stat","r");
	if(!fp){
		perror("fopen");
		exit(0);
	}
	char buff[1000];
	fgets(buff,sizeof(buff),fp);
	char *p = strtok(buff," ");
	int i = 0;
	long long ans=0;
	while(p){
		if(i>0)ans += atoi(p);
		p = strtok(NULL," ");
		i++;
	}
	return ans;
}

void usage_stats(int pid,int suggest_flag,map <long long,long long> &mp,vector<long long> &parents){
	int i=0;
	char path[256];
	mp[pid] = get_usage(pid);
	cout << "Current process id " << pid << endl;
	parents.clear();
	parents.push_back(pid);	
	while(1){
	  	snprintf(path, sizeof(path), "/proc/%d/status", pid);
		FILE* file = fopen(path, "r");
		if(!file){
			perror("fopen");
			return;
		}
		char line[256];
  		while(fgets(line, sizeof(line), file)){
    		if(strncmp(line, "PPid:", 5) == 0){
      			int ppid;
      			sscanf(line + 5, "%d", &ppid); 
				cout << "Parent process ID: " << ppid << endl;
      			parents.push_back(ppid);
				if(ppid==0){
					pid=ppid;
					break;
				}
				mp[ppid] = get_usage(ppid);
				// cout << mp[ppid] << endl;
				pid = ppid;
				break;
    		}
  		}
		if(pid==0)break;
		fclose(file);
		i++;
	}
	parents.push_back(0);
	long long total_time = get_total_usage();
	// cout << "Total time " << total_time << endl;
	mp[0] = total_time;		
}

int main(int argc,char *argv[]){
	int pid,suggest_flag=0;
	if(argc==2){
		pid = atoi(argv[1]);
	}
	else if(argc==3){
		pid = (strcmp(argv[1],"-suggest")==0)? 2:1;
		suggest_flag=1;
		pid = atoi(argv[pid]);
	}
	char path[64];
	map <long long,long long> mp1,mp2,process_time;
	mp1.clear();
	mp2.clear();
	vector <long long> v1;
	usage_stats(pid,suggest_flag,mp1,v1);
	if(suggest_flag==0){
		exit(0);
	}
	sleep(5);
	usage_stats(pid,suggest_flag,mp2,v1);

	for(auto &it:mp1){
		if(mp2.find(it.first)==mp2.end()){
			cout << "Error" << endl; //check
		}
		//comment this line later
		cout << "Process " << it.first << " CPU % " << (-it.second + mp2[it.first]) << endl;	
		process_time[it.first] = mp2[it.first]-it.second;
	}

	int len = v1.size();
	if(len <= 2){
		printf("Please check pid again using htop!\n");
		exit(0);
	}	
	long long curr_usage,prev_usage = 0;
	for(int i=0;i<len;i++){
		if(i+1==len)break;
		curr_usage = process_time[v1[i]];
		if(curr_usage < (1.0*prev_usage)/THRESHOLD){
			cout << "Process ID for the parent malware process P is: " << v1[i] << endl;
			exit(0);
		}
		prev_usage = curr_usage;
	}		
	cout << "Please re-check pid using htop, no suitable processes found" << endl;
	return 0; 
}
